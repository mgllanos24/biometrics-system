<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometrics Registration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        label {
            display: block;
            margin: 8px 0 4px;
        }
        input, button {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
        }
        canvas, video {
            display: block;
            margin: 16px auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Biometrics Registration</h1>
        <form id="registrationForm">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" placeholder="Enter your first name" required>

            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" placeholder="Enter your last name" required>

            <button type="button" id="startRegistration">Start Registration</button>
        </form>

        <video id="video" width="320" height="240" autoplay></video>
        <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
        <p id="status"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const status = document.getElementById('status');
        const startRegistration = document.getElementById('startRegistration');

        let descriptors = [];

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await loadModels();
            } catch (error) {
                status.textContent = "Camera access denied.";
                console.error(error);
            }
        }

        async function loadModels() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
            status.textContent = "Models loaded. Ready to register.";
        }

        async function captureDescriptors() {
            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (detections) {
                descriptors.push(Array.from(detections.descriptor));
                return true;
            }
            return false;
        }

        async function saveUserData(firstName, lastName, descriptors) {
            try {
                const signatureImageDataUrl = await createSignatureImageDataUrl(`${firstName} ${lastName}`);
                const faceImageDataUrl = canvas.toDataURL('image/png');

                const response = await fetch('http://localhost:3000/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        biometrics: descriptors,
                        profilePicture: faceImageDataUrl,
                        signature: signatureImageDataUrl,
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('User saved:', data);
                    alert('User registered successfully!');
                } else {
                    console.error('Error saving user:', response.statusText);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function createSignatureImageDataUrl(signatureText) {
            const sigCanvas = document.createElement('canvas');
            sigCanvas.width = 800;
            sigCanvas.height = 200;
            const ctx = sigCanvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, sigCanvas.width, sigCanvas.height);
            ctx.fillStyle = 'black';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(signatureText, sigCanvas.width / 2, sigCanvas.height / 2);
            return sigCanvas.toDataURL('image/png');
        }

        startRegistration.addEventListener('click', async () => {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();

            if (!firstName || !lastName) {
                alert('Please enter both first and last names.');
                return;
            }

            status.textContent = "Capturing face data. Please hold still.";
            const success = await captureDescriptors();
            if (success) {
                await saveUserData(firstName, lastName, descriptors);
                status.textContent = "Registration complete.";
            } else {
                status.textContent = "Face not detected. Please try again.";
            }
        });

        startCamera();
    </script>
</body>
</html>
